<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>M4E Synthetic Household Explorer</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
    body{background:#06111c;color:#c8d8e8;font-family:'DM Sans',sans-serif;}
    ::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:#0a1825;}
    ::-webkit-scrollbar-thumb{background:#1e3048;border-radius:3px;}
    select option{background:#0d1e2e;}
    input::placeholder{color:#3d5a73;}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useCallback } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CENSUS DISTRIBUTIONS â€” Ward 19 Beaches-East York 2021
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CENSUS = {
  totalHouseholds: 10500,
  ageGroups: [
    {min:0,max:4,w:.056},{min:5,max:9,w:.059},{min:10,max:14,w:.057},
    {min:15,max:19,w:.051},{min:20,max:24,w:.049},{min:25,max:29,w:.056},
    {min:30,max:34,w:.072},{min:35,max:39,w:.081},{min:40,max:44,w:.082},
    {min:45,max:49,w:.074},{min:50,max:54,w:.075},{min:55,max:59,w:.074},
    {min:60,max:64,w:.065},{min:65,max:69,w:.052},{min:70,max:74,w:.041},
    {min:75,max:79,w:.025},{min:80,max:84,w:.016},{min:85,max:98,w:.015},
  ],
  dwellingTypes: [
    {type:"Single-detached house",w:.31},{type:"Semi-detached house",w:.24},
    {type:"Row house / townhouse",w:.09},{type:"Duplex",w:.05},
    {type:"Apartment, low-rise (<5 storeys)",w:.22},
    {type:"Apartment, high-rise (5+ storeys)",w:.09},
  ],
  tenure:[{type:"Owner",w:.58},{type:"Renter",w:.42}],
  householdType:[
    {type:"One-person",w:.32},{type:"Couple, no children",w:.26},
    {type:"Couple with children",w:.22},{type:"Single parent",w:.10},
    {type:"Multigenerational/other",w:.10},
  ],
  householdSize:[
    {size:1,w:.32},{size:2,w:.32},{size:3,w:.16},
    {size:4,w:.13},{size:5,w:.05},{size:6,w:.02},
  ],
  income:[
    {bracket:"Under $30,000",w:.12,min:8000,max:29999},
    {bracket:"$30,000â€“$49,999",w:.11,min:30000,max:49999},
    {bracket:"$50,000â€“$74,999",w:.14,min:50000,max:74999},
    {bracket:"$75,000â€“$99,999",w:.14,min:75000,max:99999},
    {bracket:"$100,000â€“$149,999",w:.20,min:100000,max:149999},
    {bracket:"$150,000â€“$199,999",w:.14,min:150000,max:199999},
    {bracket:"$200,000 and over",w:.15,min:200000,max:380000},
  ],
  education:[
    {level:"No certificate/diploma",w:.07},{level:"Secondary school diploma",w:.18},
    {level:"Trades/apprenticeship",w:.04},{level:"College diploma",w:.16},
    {level:"Bachelor's degree",w:.30},{level:"Graduate/professional degree",w:.25},
  ],
  employment:[
    {status:"Employed â€“ full-time",w:.48},{status:"Employed â€“ part-time",w:.12},
    {status:"Self-employed",w:.10},{status:"Unemployed",w:.04},
    {status:"Not in labour force",w:.26},
  ],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BEHAVIOURAL DISTRIBUTIONS
// Calibrated to M4E/Beaches context:
// - High walkability (Walk Score ~88), strong TTC usage
// - Affluent, high digital adoption
// - Strong parks/beach recreation culture
// - Mix of owner/renter shelter burden patterns
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BEH = {
  // TRANSIT â€” TTC Ridership data + Beaches travel patterns
  transitMode:[
    {mode:"TTC â€“ frequent (4â€“5x/week)",w:.28},
    {mode:"TTC â€“ occasional (1â€“3x/week)",w:.22},
    {mode:"Walk / cycle primary",w:.18},
    {mode:"Car â€“ primary",w:.20},
    {mode:"Car + TTC combination",w:.08},
    {mode:"Remote / minimal travel",w:.04},
  ],
  // Weekly TTC trips range by mode (used for numeric field)
  transitTrips:{
    "TTC â€“ frequent (4â€“5x/week)":[7,12],
    "TTC â€“ occasional (1â€“3x/week)":[2,6],
    "Walk / cycle primary":[0,2],
    "Car â€“ primary":[0,1],
    "Car + TTC combination":[3,6],
    "Remote / minimal travel":[0,1],
  },
  transitPass:[
    {type:"Presto monthly",w:.38},
    {type:"Pay-per-ride",w:.20},
    {type:"No Presto / non-rider",w:.42},
  ],

  // DIGITAL â€” adjusted for high-income, high-education neighbourhood
  primaryDevice:[
    {device:"Smartphone (iOS)",w:.48},
    {device:"Smartphone (Android)",w:.22},
    {device:"Laptop/desktop primary",w:.18},
    {device:"Tablet primary",w:.07},
    {device:"Multi-device",w:.05},
  ],
  internetUsage:[
    {usage:"Heavy (6+ hrs/day)",w:.28},
    {usage:"Moderate (3â€“6 hrs/day)",w:.42},
    {usage:"Light (1â€“3 hrs/day)",w:.22},
    {usage:"Minimal (<1 hr/day)",w:.08},
  ],
  searchEngine:[
    {engine:"Google",w:.82},{engine:"Bing",w:.07},
    {engine:"DuckDuckGo",w:.07},{engine:"Other",w:.04},
  ],
  onlineShopping:[
    {freq:"Weekly",w:.25},{freq:"2â€“3x/month",w:.35},
    {freq:"Monthly",w:.25},{freq:"Rarely",w:.15},
  ],

  // PRODUCTS / OWNERSHIP
  carOwnership:[
    {own:"No car",w:.38},{own:"1 car",w:.44},{own:"2+ cars",w:.18},
  ],
  bikeOwnership:[
    {own:"No bike",w:.30},{own:"1 bike",w:.42},{own:"2+ bikes",w:.28},
  ],
  streamingServices:[
    {count:"None",w:.08},{count:"1 service",w:.22},
    {count:"2â€“3 services",w:.45},{count:"4+ services",w:.25},
  ],
  // Top streaming combos for detail display
  streamingOptions:["Netflix","Amazon Prime","Disney+","Apple TV+","Crave","CBC Gem","Spotify","YouTube Premium","Tubi"],

  // RECREATION & PARKS â€” Beaches is highly active outdoor neighbourhood
  beachVisitFreq:[
    {freq:"Weekly (summer)",w:.38},{freq:"Monthly",w:.28},
    {freq:"A few times/year",w:.22},{freq:"Rarely / never",w:.12},
  ],
  parkActivities:[
    {act:"Walking/jogging",w:.35},{act:"Dog walking",w:.20},
    {act:"Cycling",w:.18},{act:"Beach/swimming",w:.12},
    {act:"Sports/fitness",w:.10},{act:"Passive/picnic",w:.05},
  ],
  transitToParks:[
    {mode:"Walk",w:.58},{mode:"Cycle",w:.22},
    {mode:"TTC",w:.12},{mode:"Drive",w:.08},
  ],
  facilityUsage:[
    {fac:"Beaches Recreation Centre",w:.30},
    {fac:"Woodbine Beach / Boardwalk",w:.35},
    {fac:"Kew Gardens",w:.20},
    {fac:"Glen Stewart Ravine",w:.10},
    {fac:"Ted Reeve Arena",w:.05},
  ],

  // SHELTER COSTS & BURDEN
  // Owner shelter costs calibrated to M4E home values / mortgage rates
  ownerMonthlyCost:[
    {range:"Under $1,500",w:.08,min:800,max:1499},
    {range:"$1,500â€“$2,499",w:.18,min:1500,max:2499},
    {range:"$2,500â€“$3,499",w:.28,min:2500,max:3499},
    {range:"$3,500â€“$4,999",w:.28,min:3500,max:4999},
    {range:"$5,000+",w:.18,min:5000,max:8500},
  ],
  // Renter shelter costs (M4E rents are high)
  renterMonthlyCost:[
    {range:"Under $1,500",w:.12,min:900,max:1499},
    {range:"$1,500â€“$2,499",w:.38,min:1500,max:2499},
    {range:"$2,500â€“$3,499",w:.32,min:2500,max:3499},
    {range:"$3,500+",w:.18,min:3500,max:5500},
  ],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RNG + HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rng32(seed) {
  return () => {
    seed|=0; seed=seed+0x6D2B79F5|0;
    let t=Math.imul(seed^seed>>>15,1|seed);
    t=t+Math.imul(t^t>>>7,61|t)^t;
    return ((t^t>>>14)>>>0)/4294967296;
  };
}
function wc(items,rng){
  const tot=items.reduce((s,i)=>s+(i.w||i.weight||0),0);
  let r=rng()*tot;
  for(const it of items){r-=(it.w||it.weight||0);if(r<=0)return it;}
  return items[items.length-1];
}
function pick(arr,rng){return arr[Math.floor(rng()*arr.length)];}
function ri(min,max,rng){return min+Math.floor(rng()*(max-min+1));}
function genAge(rng,minA=0,maxA=98){
  const v=CENSUS.ageGroups.filter(g=>g.max>=minA&&g.min<=maxA);
  const g=wc(v.length?v:CENSUS.ageGroups,rng);
  return Math.max(minA,Math.min(maxA,ri(g.min,g.max,rng)));
}
function eduForAge(age,rng){
  if(age<15)return"N/A";
  if(age<20)return wc([{level:"No certificate/diploma",w:.55},{level:"Secondary school diploma",w:.45}],rng).level;
  if(age<25)return wc([{level:"No certificate/diploma",w:.10},{level:"Secondary school diploma",w:.30},{level:"College diploma",w:.25},{level:"Bachelor's degree",w:.30},{level:"Graduate/professional degree",w:.05}],rng).level;
  return wc(CENSUS.education,rng).level;
}
function empForAge(age,rng){
  if(age<15)return"N/A";
  if(age>=70)return wc([{status:"Employed â€“ part-time",w:.08},{status:"Self-employed",w:.05},{status:"Not in labour force",w:.87}],rng).status;
  if(age>=65)return wc([{status:"Employed â€“ full-time",w:.12},{status:"Employed â€“ part-time",w:.15},{status:"Self-employed",w:.08},{status:"Not in labour force",w:.65}],rng).status;
  if(age<20) return wc([{status:"Employed â€“ part-time",w:.35},{status:"Unemployed",w:.08},{status:"Not in labour force",w:.57}],rng).status;
  return wc(CENSUS.employment,rng).status;
}
function mkPerson(rng,age,sex,rel){
  return{sex,age,relationship:rel,education:eduForAge(age,rng),employment:empForAge(age,rng)};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BEHAVIOURAL GENERATOR
// Takes a separate rng so base demographics and behaviour
// can be resampled independently
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genBehaviour(rng, tenure, income, householdSize, householdType) {
  // Transit â€” modulate by income and household type
  const transitMode = wc(BEH.transitMode, rng);
  const [tMin,tMax] = BEH.transitTrips[transitMode.mode];
  const weeklyTTC = ri(tMin, tMax, rng);
  const transitPass = wc(BEH.transitPass, rng);

  // Digital
  const device = wc(BEH.primaryDevice, rng);
  const internet = wc(BEH.internetUsage, rng);
  const search = wc(BEH.searchEngine, rng);
  const shopping = wc(BEH.onlineShopping, rng);

  // Products â€” car ownership correlates with household size / income
  // High income or families more likely to own car
  const carW = income > 100000 || householdSize >= 3
    ? BEH.carOwnership.map(c=>({...c, w: c.own==="No car"?.22:c.own==="1 car"?.50:.28}))
    : BEH.carOwnership;
  const car = wc(carW, rng);
  const bike = wc(BEH.bikeOwnership, rng);
  const streaming = wc(BEH.streamingServices, rng);
  // Pick actual streaming services
  const numServices = streaming.count==="None"?0:streaming.count==="1 service"?1:streaming.count==="2â€“3 services"?ri(2,3,rng):ri(4,6,rng);
  const services = [];
  const pool = [...BEH.streamingOptions];
  for(let i=0;i<Math.min(numServices,pool.length);i++){
    const idx=Math.floor(rng()*pool.length);
    services.push(pool.splice(idx,1)[0]);
  }

  // Recreation â€” Beaches households are active
  const beachFreq = wc(BEH.beachVisitFreq, rng);
  const parkAct = wc(BEH.parkActivities, rng);
  const parkTransit = wc(BEH.transitToParks, rng);
  const facility = wc(BEH.facilityUsage, rng);

  // Shelter costs
  const costDist = tenure==="Owner" ? BEH.ownerMonthlyCost : BEH.renterMonthlyCost;
  const costBracket = wc(costDist, rng);
  const monthlyCost = ri(costBracket.min, costBracket.max, rng);
  // Shelter burden: % of monthly income spent on shelter
  const monthlyIncome = income / 12;
  const shelterBurden = Math.round((monthlyCost / monthlyIncome) * 100);
  const burdened = shelterBurden >= 30; // CMHC definition

  return {
    // Transit
    transitMode: transitMode.mode,
    weeklyTTCTrips: weeklyTTC,
    prestoStatus: transitPass.type,
    // Digital
    primaryDevice: device.device,
    internetUsage: internet.usage,
    searchEngine: search.engine,
    onlineShopping: shopping.freq,
    // Products
    carOwnership: car.own,
    bikeOwnership: bike.own,
    streamingCount: streaming.count,
    streamingServices: services,
    // Recreation
    beachVisitFreq: beachFreq.freq,
    primaryParkActivity: parkAct.act,
    parkAccessMode: parkTransit.mode,
    primaryFacility: facility.fac,
    // Shelter
    monthlyShelterCost: monthlyCost,
    shelterCostRange: costBracket.range,
    shelterBurdenPct: shelterBurden,
    isShelterBurdened: burdened,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOUSEHOLD GENERATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genHH(id, demSeed, behSeed) {
  const rng = rng32(demSeed + id);

  const dw  = wc(CENSUS.dwellingTypes, rng);
  const ten = wc(CENSUS.tenure, rng);
  const hht = wc(CENSUS.householdType, rng);
  const inc = wc(CENSUS.income, rng);
  const sz  = wc(CENSUS.householdSize, rng).size;
  const income = ri(inc.min, inc.max, rng);
  const members = [];

  const HEAD="Household maintainer",SPOUSE="Spouse / partner",CHILD="Child",PARENT="Parent / grandparent",OTHER="Other";

  if(hht.type==="One-person"){
    members.push(mkPerson(rng,genAge(rng,18,98),rng()<.52?"F":"M",HEAD));
  } else if(hht.type==="Couple, no children"){
    const a1=genAge(rng,22,85),s1=rng()<.5?"F":"M",s2=s1==="F"?(rng()<.92?"M":"F"):(rng()<.92?"F":"M");
    const a2=Math.max(22,Math.min(88,a1+ri(-8,8,rng)));
    members.push(mkPerson(rng,a1,s1,HEAD),mkPerson(rng,a2,s2,SPOUSE));
    for(let i=0;i<Math.max(0,sz-2);i++)members.push(mkPerson(rng,genAge(rng,18,50),rng()<.5?"F":"M",OTHER));
  } else if(hht.type==="Couple with children"){
    const a1=genAge(rng,28,60),s1=rng()<.5?"F":"M",s2=s1==="F"?"M":"F";
    const a2=Math.max(26,Math.min(65,a1+ri(-6,6,rng)));
    members.push(mkPerson(rng,a1,s1,HEAD),mkPerson(rng,a2,s2,SPOUSE));
    const nk=Math.max(1,Math.min(sz-2,4));
    for(let k=0;k<nk;k++)members.push(mkPerson(rng,ri(0,Math.min(24,a1-18),rng),rng()<.5?"F":"M",CHILD));
  } else if(hht.type==="Single parent"){
    const a1=genAge(rng,25,60);
    members.push(mkPerson(rng,a1,rng()<.78?"F":"M",HEAD));
    const nk=Math.max(1,Math.min(sz-1,4));
    for(let k=0;k<nk;k++)members.push(mkPerson(rng,ri(0,Math.min(22,a1-18),rng),rng()<.5?"F":"M",CHILD));
  } else {
    const a1=genAge(rng,30,65);
    members.push(mkPerson(rng,a1,rng()<.5?"F":"M",HEAD));
    for(let i=0;i<Math.max(1,sz-1);i++){
      const roll=rng();let rel,minA,maxA;
      if(roll<.35){rel=SPOUSE;minA=Math.max(22,a1-10);maxA=a1+10;}
      else if(roll<.60){rel=CHILD;minA=0;maxA=Math.min(30,a1-18);}
      else if(roll<.80){rel=PARENT;minA=Math.max(50,a1+20);maxA=90;}
      else{rel=OTHER;minA=18;maxA=70;}
      members.push(mkPerson(rng,genAge(rng,Math.max(0,minA),Math.max(1,maxA)),rng()<.5?"F":"M",rel));
    }
  }

  const beh = genBehaviour(rng32(behSeed + id), ten.type, income, members.length, hht.type);

  return {
    id:`M4E-${String(id).padStart(5,"0")}`,
    fsa:"M4E",
    dwelling:dw.type, tenure:ten.type, householdType:hht.type,
    householdSize:members.length, incomeBracket:inc.bracket,
    annualIncome:income, members,
    beh,
  };
}

function genBatch(start, count, demSeed, behSeed) {
  const out=[];
  for(let i=0;i<count;i++) out.push(genHH(start+i, demSeed, behSeed));
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEM_SEED = 20210511;
const PAGE = 40, TOTAL = 10500;
const C = {
  bg:"#06111c",surf:"#0a1825",card:"#0d1e2e",cardSel:"#0c2240",
  bord:"#162535",bordAc:"#2a5080",txt:"#c8d8e8",mut:"#4a6a85",
  acc:"#4a90d9",grn:"#52c97a",red:"#e06060",yel:"#e8b84b",
  pur:"#9b7fd4",pnk:"#d47fa0",teal:"#4ab8d4",org:"#e8884b",
};
const si={background:C.card,border:`1px solid ${C.bord}`,color:C.txt,borderRadius:5,padding:"5px 9px",fontSize:12,fontFamily:"'DM Mono',monospace",cursor:"pointer",outline:"none"};

function Tag({ch,col}){return <span style={{background:col+"22",color:col,border:`1px solid ${col}44`,borderRadius:3,padding:"1px 6px",fontSize:10,fontWeight:500,whiteSpace:"nowrap"}}>{ch}</span>;}
function AgeBadge({age}){
  const bg=age<15?"#1a4a7a":age<30?"#1a5a3a":age<50?"#4a3a10":age<65?"#4a2020":"#3a2a5a";
  const cl=age<15?"#7ab8f5":age<30?"#6dd89a":age<50?"#e8c060":age<65?"#e08888":"#b898e8";
  return <span style={{background:bg,color:cl,borderRadius:3,padding:"1px 5px",fontSize:10,fontWeight:700}}>{age}</span>;
}

// Compact behavioural icon strip shown on each card
function BehStrip({beh}) {
  const transit = beh.weeklyTTCTrips > 4 ? C.acc : beh.weeklyTTCTrips > 1 ? C.teal : C.mut;
  const shelter = beh.isShelterBurdened ? C.red : beh.shelterBurdenPct >= 25 ? C.yel : C.grn;
  const digital = beh.internetUsage==="Heavy (6+ hrs/day)" ? C.pur : beh.internetUsage==="Moderate (3â€“6 hrs/day)" ? C.teal : C.mut;
  const rec = beh.beachVisitFreq==="Weekly (summer)" ? C.grn : beh.beachVisitFreq==="Monthly" ? C.teal : C.mut;
  const car = beh.carOwnership==="No car" ? C.grn : beh.carOwnership==="1 car" ? C.yel : C.org;
  return (
    <div style={{display:"flex",gap:6,alignItems:"center",marginTop:7,flexWrap:"wrap"}}>
      <Tag ch={`ğŸšŒ ${beh.weeklyTTCTrips}x/wk`} col={transit}/>
      <Tag ch={`ğŸ  $${beh.monthlyShelterCost.toLocaleString()}/mo`} col={shelter}/>
      <Tag ch={`ğŸ’» ${beh.primaryDevice.split(" ")[0]}`} col={digital}/>
      <Tag ch={`ğŸ– ${beh.beachVisitFreq.split(" ")[0]}`} col={rec}/>
      <Tag ch={`ğŸš— ${beh.carOwnership}`} col={car}/>
      {beh.streamingServices.slice(0,2).map(s=><Tag key={s} ch={s} col={C.pur}/>)}
      {beh.isShelterBurdened && <Tag ch="âš  burdened" col={C.red}/>}
    </div>
  );
}

function BehSection({title, icon, children}) {
  return (
    <div style={{marginTop:14}}>
      <div style={{color:C.mut,fontSize:10,textTransform:"uppercase",letterSpacing:1,marginBottom:6,display:"flex",alignItems:"center",gap:5}}>
        <span>{icon}</span><span>{title}</span>
      </div>
      <div style={{display:"flex",flexDirection:"column",gap:3}}>{children}</div>
    </div>
  );
}

function BehRow({label, value, color}) {
  return (
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"4px 0",borderBottom:`1px solid ${C.bord}`}}>
      <span style={{color:C.mut,fontSize:11}}>{label}</span>
      <span style={{color:color||C.txt,fontSize:11,fontWeight:500,textAlign:"right",maxWidth:"60%"}}>{value}</span>
    </div>
  );
}

function MemberRow({m}){
  const RC={"Household maintainer":C.acc,"Spouse / partner":C.pnk,"Child":"#6dd89a","Parent / grandparent":C.pur,"Other":C.mut};
  const EC={"Employed â€“ full-time":C.grn,"Employed â€“ part-time":C.teal,"Self-employed":C.yel,"Unemployed":C.red,"Not in labour force":C.mut,"N/A":C.mut};
  return (
    <div style={{display:"flex",alignItems:"center",gap:7,padding:"5px 0",borderBottom:`1px solid ${C.bord}`,flexWrap:"wrap"}}>
      <span style={{color:m.sex==="F"?C.pnk:C.acc,fontSize:13}}>{m.sex==="F"?"â™€":"â™‚"}</span>
      <AgeBadge age={m.age}/>
      <Tag ch={m.relationship} col={RC[m.relationship]||C.mut}/>
      <Tag ch={m.employment} col={EC[m.employment]||C.mut}/>
      <span style={{color:C.mut,fontSize:10,fontFamily:"monospace"}}>{m.education==="N/A"?"":m.education}</span>
    </div>
  );
}

function HHCard({hh,onClick,sel}){
  return (
    <div onClick={()=>onClick(hh)} style={{background:sel?C.cardSel:C.card,border:`1px solid ${sel?C.bordAc:C.bord}`,borderLeft:`3px solid ${sel?C.acc:C.bord}`,borderRadius:6,padding:"10px 14px",cursor:"pointer",transition:"all 0.12s",marginBottom:5}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:8}}>
        <div>
          <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap",marginBottom:4}}>
            <span style={{color:C.acc,fontFamily:"monospace",fontSize:11}}>{hh.id}</span>
            <Tag ch={hh.dwelling} col={C.mut}/>
            <Tag ch={hh.tenure} col={hh.tenure==="Owner"?C.grn:C.yel}/>
          </div>
          <div style={{color:C.txt,fontSize:13,fontWeight:600}}>{hh.householdType} Â· {hh.householdSize} person{hh.householdSize>1?"s":""}</div>
        </div>
        <div style={{textAlign:"right",flexShrink:0}}>
          <div style={{color:C.grn,fontWeight:700,fontSize:13,fontFamily:"monospace"}}>${hh.annualIncome.toLocaleString()}</div>
          <div style={{color:C.mut,fontSize:10}}>{hh.incomeBracket}</div>
        </div>
      </div>

      {/* Member pills */}
      <div style={{display:"flex",flexWrap:"wrap",gap:3,marginTop:6}}>
        {hh.members.map((m,i)=>(
          <span key={i} style={{display:"inline-flex",alignItems:"center",gap:3,background:C.surf,border:`1px solid ${C.bord}`,borderRadius:20,padding:"2px 7px",fontSize:11}}>
            <span style={{color:m.sex==="F"?C.pnk:C.acc}}>{m.sex==="F"?"â™€":"â™‚"}</span>
            <AgeBadge age={m.age}/>
          </span>
        ))}
      </div>

      {/* Behavioural strip */}
      <BehStrip beh={hh.beh}/>
    </div>
  );
}

function DetailPanel({hh,onClose}){
  if(!hh) return null;
  const b = hh.beh;
  const burdenColor = b.isShelterBurdened ? C.red : b.shelterBurdenPct>=25 ? C.yel : C.grn;
  return (
    <div style={{background:C.surf,border:`1px solid ${C.bord}`,borderRadius:8,padding:18,position:"sticky",top:10,overflowY:"auto",maxHeight:"calc(100vh - 40px)"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <span style={{color:C.acc,fontFamily:"monospace",fontSize:13,fontWeight:600}}>{hh.id}</span>
        <button onClick={onClose} style={{background:"none",border:"none",color:C.mut,cursor:"pointer",fontSize:22,lineHeight:1}}>Ã—</button>
      </div>

      {/* Core household */}
      {[["FSA","M4E"],["Dwelling",hh.dwelling],["Tenure",hh.tenure],["Household Type",hh.householdType],["Size",`${hh.householdSize} person${hh.householdSize>1?"s":""}`],["Income Bracket",hh.incomeBracket],["Annual Income","$"+hh.annualIncome.toLocaleString()]].map(([k,v])=>(
        <div key={k} style={{display:"flex",justifyContent:"space-between",padding:"4px 0",borderBottom:`1px solid ${C.bord}`}}>
          <span style={{color:C.mut,fontSize:11}}>{k}</span>
          <span style={{color:C.txt,fontSize:11,fontWeight:500,textAlign:"right",maxWidth:"60%"}}>{v}</span>
        </div>
      ))}

      {/* Members */}
      <BehSection title="Household Members" icon="ğŸ‘¥">
        {hh.members.map((m,i)=><MemberRow key={i} m={m}/>)}
      </BehSection>

      {/* Transit */}
      <BehSection title="Transit Behaviour" icon="ğŸšŒ">
        <BehRow label="Primary mode" value={b.transitMode} color={C.acc}/>
        <BehRow label="Weekly TTC trips" value={b.weeklyTTCTrips}/>
        <BehRow label="Presto status" value={b.prestoStatus}/>
      </BehSection>

      {/* Digital */}
      <BehSection title="Digital Behaviour" icon="ğŸ’»">
        <BehRow label="Primary device" value={b.primaryDevice}/>
        <BehRow label="Internet usage" value={b.internetUsage}/>
        <BehRow label="Search engine" value={b.searchEngine}/>
        <BehRow label="Online shopping" value={b.onlineShopping}/>
      </BehSection>

      {/* Products */}
      <BehSection title="Product Ownership" icon="ğŸ›">
        <BehRow label="Car ownership" value={b.carOwnership} color={b.carOwnership==="No car"?C.grn:C.yel}/>
        <BehRow label="Bike ownership" value={b.bikeOwnership}/>
        <BehRow label="Streaming" value={b.streamingCount}/>
        {b.streamingServices.length>0&&(
          <div style={{display:"flex",flexWrap:"wrap",gap:4,padding:"4px 0"}}>
            {b.streamingServices.map(s=><Tag key={s} ch={s} col={C.pur}/>)}
          </div>
        )}
      </BehSection>

      {/* Recreation */}
      <BehSection title="Recreation & Parks" icon="ğŸ–">
        <BehRow label="Beach visits" value={b.beachVisitFreq} color={C.grn}/>
        <BehRow label="Primary activity" value={b.primaryParkActivity}/>
        <BehRow label="Gets to parks by" value={b.parkAccessMode}/>
        <BehRow label="Primary facility" value={b.primaryFacility}/>
      </BehSection>

      {/* Shelter */}
      <BehSection title="Shelter Costs" icon="ğŸ ">
        <BehRow label="Monthly cost" value={`$${b.monthlyShelterCost.toLocaleString()}`} color={burdenColor}/>
        <BehRow label="Cost range" value={b.shelterCostRange}/>
        <BehRow label="Shelter burden" value={`${b.shelterBurdenPct}% of income`} color={burdenColor}/>
        <BehRow label="CMHC burdened (â‰¥30%)" value={b.isShelterBurdened?"Yes â€” over threshold":"No"} color={b.isShelterBurdened?C.red:C.grn}/>
      </BehSection>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App() {
  const [data, setData]       = useState([]);
  const [busy, setBusy]       = useState(false);
  const [prog, setProg]       = useState(0);
  const [behSeed, setBehSeed] = useState(Date.now());
  const [resampling, setResampling] = useState(false);
  const [sel, setSel]         = useState(null);
  const [pg, setPg]           = useState(1);
  const [q, setQ]             = useState("");
  const [fDw,setFDw]          = useState("All");
  const [fTen,setFTen]        = useState("All");
  const [fInc,setFInc]        = useState("All");
  const [fTyp,setFTyp]        = useState("All");
  const [fSz,setFSz]          = useState("All");
  const [fBeh,setFBeh]        = useState("All");
  const [srt,setSrt]          = useState("id");

  // Generate base demographics + behaviour
  useEffect(()=>{
    if(busy||data.length>=TOTAL) return;
    setBusy(true);
    const B=500;
    const run=(s)=>{
      if(s>=TOTAL){setBusy(false);return;}
      setTimeout(()=>{
        setData(p=>[...p,...genBatch(s+1,Math.min(B,TOTAL-s),DEM_SEED,behSeed)]);
        setProg(Math.min(s+B,TOTAL));
        run(s+B);
      },0);
    };
    run(0);
  },[]);

  // Resample behaviour only
  const resample = useCallback(()=>{
    if(busy||resampling) return;
    const newSeed = Date.now();
    setBehSeed(newSeed);
    setResampling(true);
    setSel(null);
    const B=1000;
    let next = [...data];
    const run=(s)=>{
      if(s>=next.length){setResampling(false);setData([...next]);return;}
      setTimeout(()=>{
        for(let i=s;i<Math.min(s+B,next.length);i++){
          const h=next[i];
          next[i]={...h, beh:genBehaviour(rng32(newSeed+i+1), h.tenure, h.annualIncome, h.householdSize, h.householdType)};
        }
        run(s+B);
      },0);
    };
    run(0);
  },[data,busy,resampling]);

  const filt = useMemo(()=>{
    let d=data;
    if(q){const lq=q.toLowerCase();d=d.filter(h=>h.id.includes(lq)||h.householdType.toLowerCase().includes(lq)||h.beh.transitMode.toLowerCase().includes(lq)||h.beh.primaryFacility.toLowerCase().includes(lq)||h.dwelling.toLowerCase().includes(lq));}
    if(fDw!=="All")  d=d.filter(h=>h.dwelling===fDw);
    if(fTen!=="All") d=d.filter(h=>h.tenure===fTen);
    if(fInc!=="All") d=d.filter(h=>h.incomeBracket===fInc);
    if(fTyp!=="All") d=d.filter(h=>h.householdType===fTyp);
    if(fSz!=="All")  d=d.filter(h=>fSz==="4+"?h.householdSize>=4:h.householdSize===+fSz);
    if(fBeh==="TTC heavy")    d=d.filter(h=>h.beh.weeklyTTCTrips>=7);
    if(fBeh==="No car")       d=d.filter(h=>h.beh.carOwnership==="No car");
    if(fBeh==="Shelter burdened") d=d.filter(h=>h.beh.isShelterBurdened);
    if(fBeh==="Frequent beach")   d=d.filter(h=>h.beh.beachVisitFreq==="Weekly (summer)");
    if(fBeh==="Has Presto")   d=d.filter(h=>h.beh.prestoStatus==="Presto monthly");
    if(srt==="income_desc") return [...d].sort((a,b)=>b.annualIncome-a.annualIncome);
    if(srt==="income_asc")  return [...d].sort((a,b)=>a.annualIncome-b.annualIncome);
    if(srt==="size_desc")   return [...d].sort((a,b)=>b.householdSize-a.householdSize);
    if(srt==="shelter_desc")return [...d].sort((a,b)=>b.beh.shelterBurdenPct-a.beh.shelterBurdenPct);
    if(srt==="ttc_desc")    return [...d].sort((a,b)=>b.beh.weeklyTTCTrips-a.beh.weeklyTTCTrips);
    return d;
  },[data,q,fDw,fTen,fInc,fTyp,fSz,fBeh,srt]);

  const tp=Math.max(1,Math.ceil(filt.length/PAGE));
  const cp=Math.min(pg,tp);
  const pd=filt.slice((cp-1)*PAGE,cp*PAGE);
  const pct=Math.round(prog/TOTAL*100);

  const stats=useMemo(()=>{
    if(!data.length) return null;
    const s=[...data].sort((a,b)=>a.annualIncome-b.annualIncome);
    const tp=data.reduce((x,h)=>x+h.householdSize,0);
    const burdened=data.filter(h=>h.beh.isShelterBurdened).length;
    const noCar=data.filter(h=>h.beh.carOwnership==="No car").length;
    const ttcHeavy=data.filter(h=>h.beh.weeklyTTCTrips>=7).length;
    return{
      hh:data.length, persons:tp, avg:(tp/data.length).toFixed(2),
      med:s[Math.floor(data.length/2)]?.annualIncome,
      own:Math.round(data.filter(h=>h.tenure==="Owner").length/data.length*100),
      burdened:Math.round(burdened/data.length*100),
      noCar:Math.round(noCar/data.length*100),
      ttcHeavy:Math.round(ttcHeavy/data.length*100),
    };
  },[data]);


  const active=q||fDw!=="All"||fTen!=="All"||fInc!=="All"||fTyp!=="All"||fSz!=="All"||fBeh!=="All";
  const reset=()=>{setQ("");setFDw("All");setFTen("All");setFInc("All");setFTyp("All");setFSz("All");setFBeh("All");setSrt("id");setPg(1);};

  const pgBtns=(()=>{
    if(tp<=7)return Array.from({length:tp},(_,i)=>i+1);
    if(cp<=4)return[1,2,3,4,5,6,7];
    if(cp>=tp-3)return[tp-6,tp-5,tp-4,tp-3,tp-2,tp-1,tp];
    return[cp-3,cp-2,cp-1,cp,cp+1,cp+2,cp+3];
  })();

  return (
    <div style={{background:C.bg,minHeight:"100vh",display:"flex",flexDirection:"column"}}>

      {/* Header */}
      <div style={{background:C.surf,borderBottom:`1px solid ${C.bord}`,padding:"12px 20px",display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:10}}>
        <div>
          <div style={{display:"flex",alignItems:"center",gap:10}}>
            <div style={{background:"#0d2540",border:`1px solid ${C.bordAc}`,borderRadius:4,padding:"3px 10px"}}>
              <span style={{color:C.acc,fontFamily:"monospace",fontWeight:700,fontSize:14,letterSpacing:1}}>M4E</span>
            </div>
            <h1 style={{color:C.txt,fontSize:15,fontWeight:600,margin:0}}>Synthetic Household Explorer</h1>
          </div>
          <div style={{color:C.mut,fontSize:11,marginTop:3,fontFamily:"monospace"}}>
            The Beaches Â· 2021 Census + Behavioural Â· {data.length.toLocaleString()} / {TOTAL.toLocaleString()} households
          </div>
        </div>
        <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
          <button onClick={resample} disabled={busy||resampling} style={{...si,padding:"6px 12px",color:C.yel,borderColor:C.yel+"44"}}>
            {resampling?"âŸ³ Resamplingâ€¦":"âŸ³ Resample Behaviour"}
          </button>

        </div>
      </div>

      {/* Progress */}
      {(busy||resampling)&&(
        <div style={{background:C.surf,padding:"0 20px 8px",borderBottom:`1px solid ${C.bord}`}}>
          <div style={{background:C.bord,borderRadius:3,height:3,overflow:"hidden"}}>
            <div style={{background:resampling?C.yel:C.acc,width:`${busy?pct:100}%`,height:"100%",transition:"width 0.3s"}}/>
          </div>
          <div style={{color:C.mut,fontSize:11,marginTop:4,fontFamily:"monospace"}}>
            {resampling?"Resampling behavioural dataâ€¦":`Generatingâ€¦ ${pct}% (${prog.toLocaleString()} households)`}
          </div>
        </div>
      )}

      {/* Filters */}
      <div style={{background:C.surf,borderBottom:`1px solid ${C.bord}`,padding:"8px 20px",display:"flex",flexWrap:"wrap",gap:7,alignItems:"center"}}>
        <input value={q} onChange={e=>{setQ(e.target.value);setPg(1);}} placeholder="Search ID, household type, transit mode, facilityâ€¦" style={{...si,padding:"6px 10px",width:280}}/>
        <select value={fTyp} onChange={e=>{setFTyp(e.target.value);setPg(1);}} style={si}>
          <option value="All">All Household Types</option>
          {CENSUS.householdType.map(t=><option key={t.type}>{t.type}</option>)}
        </select>
        <select value={fTen} onChange={e=>{setFTen(e.target.value);setPg(1);}} style={si}>
          <option value="All">Owner + Renter</option>
          <option>Owner</option><option>Renter</option>
        </select>
        <select value={fInc} onChange={e=>{setFInc(e.target.value);setPg(1);}} style={si}>
          <option value="All">All Income Brackets</option>
          {CENSUS.income.map(i=><option key={i.bracket}>{i.bracket}</option>)}
        </select>
        <select value={fDw} onChange={e=>{setFDw(e.target.value);setPg(1);}} style={si}>
          <option value="All">All Dwelling Types</option>
          {CENSUS.dwellingTypes.map(d=><option key={d.type}>{d.type}</option>)}
        </select>
        <select value={fSz} onChange={e=>{setFSz(e.target.value);setPg(1);}} style={si}>
          <option value="All">Any Size</option>
          <option value="1">1 Person</option><option value="2">2 People</option>
          <option value="3">3 People</option><option value="4+">4+ People</option>
        </select>
        <select value={fBeh} onChange={e=>{setFBeh(e.target.value);setPg(1);}} style={{...si,color:fBeh!=="All"?C.yel:C.txt}}>
          <option value="All">All Behaviours</option>
          <option>TTC heavy</option>
          <option>No car</option>
          <option>Shelter burdened</option>
          <option>Frequent beach</option>
          <option>Has Presto</option>
        </select>
        <select value={srt} onChange={e=>{setSrt(e.target.value);setPg(1);}} style={si}>
          <option value="id">Sort: ID</option>
          <option value="income_desc">Income â†“</option>
          <option value="income_asc">Income â†‘</option>
          <option value="size_desc">Size â†“</option>
          <option value="shelter_desc">Shelter burden â†“</option>
          <option value="ttc_desc">TTC trips â†“</option>
        </select>
        {active&&<button onClick={reset} style={{...si,color:C.red,padding:"5px 10px"}}>âœ• Clear</button>}
        <span style={{color:C.mut,fontSize:11,marginLeft:"auto",fontFamily:"monospace"}}>{filt.length.toLocaleString()} matching Â· pg {cp}/{tp}</span>
      </div>

      {/* Body */}
      <div style={{flex:1,display:"grid",gridTemplateColumns:sel?"1fr 420px":"1fr",maxWidth:1500,width:"100%",margin:"0 auto",padding:16,gap:16,alignItems:"start"}}>
        <div>
          {busy&&!data.length&&<div style={{color:C.mut,textAlign:"center",marginTop:80,fontSize:13}}>Generating 10,500 households with demographic + behavioural profilesâ€¦</div>}
          {!busy&&!pd.length&&<div style={{color:C.mut,textAlign:"center",marginTop:80}}>No households match your filters.</div>}
          {pd.map(hh=><HHCard key={hh.id} hh={hh} onClick={h=>setSel(sel?.id===h.id?null:h)} sel={sel?.id===hh.id}/>)}
          {tp>1&&(
            <div style={{display:"flex",justifyContent:"center",gap:5,marginTop:14,flexWrap:"wrap"}}>
              <button onClick={()=>setPg(1)} disabled={cp===1} style={si}>Â«</button>
              <button onClick={()=>setPg(p=>Math.max(1,p-1))} disabled={cp===1} style={si}>â€¹</button>
              {pgBtns.map(p=>(
                <button key={p} onClick={()=>setPg(p)} style={{...si,background:cp===p?"#0d2540":C.card,color:cp===p?C.acc:C.txt,fontWeight:cp===p?700:400,border:`1px solid ${cp===p?C.bordAc:C.bord}`}}>{p}</button>
              ))}
              <button onClick={()=>setPg(p=>Math.min(tp,p+1))} disabled={cp===tp} style={si}>â€º</button>
              <button onClick={()=>setPg(tp)} disabled={cp===tp} style={si}>Â»</button>
            </div>
          )}
        </div>
        {sel&&<DetailPanel hh={sel} onClose={()=>setSel(null)}/>}
      </div>

      {/* Footer stats */}
      {stats&&(
        <div style={{background:C.surf,borderTop:`1px solid ${C.bord}`,padding:"10px 20px",display:"flex",gap:24,flexWrap:"wrap"}}>
          {[
            ["Households",stats.hh.toLocaleString(),C.grn],
            ["Total Persons",stats.persons.toLocaleString(),C.grn],
            ["Avg HH Size",stats.avg,C.grn],
            ["Median Income","$"+stats.med?.toLocaleString(),C.grn],
            ["Owner-occupied",stats.own+"%",C.grn],
            ["Shelter burdened",stats.burdened+"%",stats.burdened>30?C.red:C.yel],
            ["No car",stats.noCar+"%",C.teal],
            ["TTC heavy users",stats.ttcHeavy+"%",C.acc],
          ].map(([k,v,c])=>(
            <div key={k}>
              <div style={{color:C.mut,fontSize:9,textTransform:"uppercase",letterSpacing:1}}>{k}</div>
              <div style={{color:c,fontWeight:700,fontSize:14,fontFamily:"monospace"}}>{v}</div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
